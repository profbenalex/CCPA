<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BCQAdmin</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      margin: 0;
      padding: 0;
    }
    img.logo {
      float: left;
      max-height: 100px;
      margin: 1em;
    }
    h1 {
      text-align: center;
      background-color: #e3e3e3;
      margin: 0;
      padding: 0.75em 0;
      font-size: 28px;
      font-weight: bold;
      clear: both;
    }
    button, select {
      font-size: 16px;
      padding: 6px 12px;
      margin: 0.5em 0.5em 0.5em 0;
      height: 36px;
      min-width: 120px;
      box-sizing: border-box;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #999;
      padding: 0.5em;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background-color: #eee;
    }
    td[contenteditable="true"] {
      background-color: #ffffcc;
    }
    select:disabled {
      background-color: #eee;
      color: #999;
    }
    #tableContainer {
      overflow-x: auto;
      margin: 1em;
    }
    td.intent, td.assertions, td.impact, td.evidence {
      padding: 0;
      vertical-align: top;
    }
    td.intent div, td.assertions div, td.impact div, td.evidence div {
      white-space: normal !important;
      width: 50ch;
      max-width: 50ch;
      height: 144px;
      max-height: 144px;
      line-height: 1.5;
      overflow-y: auto;
      overflow-wrap: break-word;
      box-sizing: border-box;
      padding: 0.5em;
      background-color: #ffffcc;
    }

    /* üìå Evaluation Panel Styles */
    #evaluationPanel {
      margin: 2em;
      padding: 1em;
      border: 2px solid #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
      max-width: 600px;
    }

    #evaluationPanel label {
      display: block;
      margin-top: 1em;
      font-weight: bold;
    }

    .rating-group {
      display: flex;
      gap: 1em;
      margin: 0.5em 0;
    }

    .rating-group label {
      font-weight: normal;
    }

    textarea {
      width: 100%;
      height: 100px;
      resize: vertical;
      font-family: Calibri, Arial, sans-serif;
    }
  </style>
</head>


<body>
  <img src="bcquality.jpeg" alt="BC Quality Logo" class="logo">
  <h1>Belgium Campus Quality Repository V1.0</h1>

  <div style="text-align:center; clear:both;">
    <button id="authButton">üîê Sign in with Google</button>
  </div>

  <div style="text-align:center; margin-top:1em;">
    <label for="filterDomain">Domain:</label>
    <select id="filterDomain"><option value="">All</option></select>

    <label for="filterTheme">Theme:</label>
    <select id="filterTheme" disabled><option value="">All</option></select>

    <label for="filterDocument">Document:</label>
    <select id="filterDocument" disabled><option value="">All</option></select>
  </div>

  <div id="tableContainer"></div>

  <!-- üìå Evaluation Panel -->
  <div id="evaluationPanel" style="display:none;">
    <h2>Evaluator Feedback</h2>

    <label for="contextSelect">Context:</label>
    <select id="contextSelect">
      <option value="Internal">Internal</option>
      <option value="External">External</option>
    </select>

    <label>Relevance:</label>
    <div class="rating-group" id="relevanceGroup">
      <label><input type="radio" name="relevance" value="1"> 1</label>
      <label><input type="radio" name="relevance" value="2"> 2</label>
      <label><input type="radio" name="relevance" value="3"> 3</label>
      <label><input type="radio" name="relevance" value="4"> 4</label>
      <label><input type="radio" name="relevance" value="5"> 5</label>
    </div>

    <label>Scope:</label>
    <div class="rating-group" id="scopeGroup">
      <label><input type="radio" name="scope" value="1"> 1</label>
      <label><input type="radio" name="scope" value="2"> 2</label>
      <label><input type="radio" name="scope" value="3"> 3</label>
      <label><input type="radio" name="scope" value="4"> 4</label>
      <label><input type="radio" name="scope" value="5"> 5</label>
    </div>

    <label>Clarity:</label>
    <div class="rating-group" id="clarityGroup">
      <label><input type="radio" name="clarity" value="1"> 1</label>
      <label><input type="radio" name="clarity" value="2"> 2</label>
      <label><input type="radio" name="clarity" value="3"> 3</label>
      <label><input type="radio" name="clarity" value="4"> 4</label>
      <label><input type="radio" name="clarity" value="5"> 5</label>
    </div>

    <label>Applicability:</label>
    <div class="rating-group" id="applicabilityGroup">
      <label><input type="radio" name="applicability" value="1"> 1</label>
      <label><input type="radio" name="applicability" value="2"> 2</label>
      <label><input type="radio" name="applicability" value="3"> 3</label>
      <label><input type="radio" name="applicability" value="4"> 4</label>
      <label><input type="radio" name="applicability" value="5"> 5</label>
    </div>

    <label for="commentBox">Comment:</label>
    <textarea id="commentBox" placeholder="Enter your evaluation comment here..."></textarea>

    <button id="submitEvaluationBtn">Submit Evaluation</button>

    <!-- Hidden Fields -->
    <input type="hidden" id="userEmail">
    <input type="hidden" id="documentName">
    <input type="hidden" id="versionNumber">
  </div>


<script>
  const clientId = '566030013012-fp4pfljo6t586lo83dq7cdf7umcs07td.apps.googleusercontent.com';
  const sheetId = '1kSctyDuy35alQsG_vN7FswSs2wKGNmk2T-N1MJWYQvI';
  const sheetName = 'documents';
  let accessToken = '';
  let userEmail = '';

  // üîê Google Sign-In and Email Extraction
  document.getElementById("authButton").addEventListener("click", () => {
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/spreadsheets',
      callback: tokenResponse => {
        accessToken = tokenResponse.access_token;

        // Decode ID token to extract email
        google.accounts.id.initialize({
          client_id: clientId,
          callback: (response) => {
            const idToken = response.credential;
            const base64Url = idToken.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            userEmail = JSON.parse(jsonPayload).email;
            document.getElementById("userEmail").value = userEmail;
          }
        });
        google.accounts.id.prompt();

        loadSheet();
      }
    });
    tokenClient.requestAccessToken();
  });

  // üì• Load data and populate form
  async function loadSheet() {
    try {
      const docRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const docData = await docRes.json();
      const allData = docData.values || [];

      setupFilters(allData);
      renderTable(allData);

      // Populate document/version into hidden inputs and show panel
      const headers = allData[0];
      const firstRow = allData[1];
      const docIndex = headers.indexOf("Document");
      const verIndex = headers.indexOf("Version");
      document.getElementById("documentName").value = firstRow[docIndex] || '';
      document.getElementById("versionNumber").value = firstRow[verIndex] || '';
      document.getElementById("evaluationPanel").style.display = "block";

    } catch (err) {
      console.error("Error loading sheet:", err);
      alert("‚ö†Ô∏è Failed to load data.");
    }
  }

  // üìù Submit evaluation to 'evaluations' sheet
  document.getElementById("submitEvaluationBtn").addEventListener("click", async () => {
    const doc = document.getElementById("documentName").value;
    const version = document.getElementById("versionNumber").value;
    const context = document.getElementById("contextSelect").value;
    const comment = document.getElementById("commentBox").value.trim();
    const user = document.getElementById("userEmail").value;

    const getRating = (name) => {
      const radios = document.getElementsByName(name);
      for (let radio of radios) {
        if (radio.checked) return radio.value;
      }
      return '';
    };

    const relevance = getRating("relevance");
    const scope = getRating("scope");
    const clarity = getRating("clarity");
    const applicability = getRating("applicability");

    if (!relevance || !scope || !clarity || !applicability || !comment) {
      alert("‚ö†Ô∏è Please complete all fields before submitting.");
      return;
    }

    const evaluationRow = [
      doc, version, context, user,
      relevance, scope, clarity, applicability, comment
    ];

    try {
      const appendRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/evaluations:append?valueInputOption=USER_ENTERED`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ values: [evaluationRow] })
      });

      if (!appendRes.ok) throw new Error("Failed to write to sheet");

      alert("‚úÖ Evaluation submitted successfully!");

      // Clear inputs
      document.getElementById("commentBox").value = '';
      ["relevance", "scope", "clarity", "applicability"].forEach(name => {
        document.querySelectorAll(`input[name="${name}"]`).forEach(el => el.checked = false);
      });

    } catch (err) {
      console.error(err);
      alert("‚ùå Error submitting evaluation.");
    }
  });
</script>

</body>
</html>
