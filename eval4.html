<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BCQAdmin</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: Calibri, Arial, sans-serif;
      font-size: 16px;
      margin: 0;
      padding: 0;
    }
    img.logo {
      float: left;
      max-height: 100px;
      margin: 1em;
    }
    h1 {
      text-align: center;
      background-color: #e3e3e3;
      margin: 0;
      padding: 0.75em 0;
      font-size: 28px;
      font-weight: bold;
      clear: both;
    }
    button, select {
      font-size: 16px;
      padding: 6px 12px;
      margin: 0.5em 0.5em 0.5em 0;
      height: 36px;
      min-width: 120px;
      box-sizing: border-box;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #999;
      padding: 0.5em;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background-color: #eee;
    }
    td[contenteditable="true"] {
      background-color: #ffffcc;
    }
    select:disabled {
      background-color: #eee;
      color: #999;
    }
    #tableContainer {
      overflow-x: auto;
      margin: 1em;
    }
    td.intent, td.assertions, td.impact, td.evidence {
      padding: 0;
      vertical-align: top;
    }
    td.intent div, td.assertions div, td.impact div, td.evidence div {
      white-space: normal !important;
      width: 50ch;
      max-width: 50ch;
      height: 144px;
      max-height: 144px;
      line-height: 1.5;
      overflow-y: auto;
      overflow-wrap: break-word;
      box-sizing: border-box;
      padding: 0.5em;
      background-color: #ffffcc;
    }
  </style>
</head>




<body>
  <img src="bcquality.jpeg" alt="BC Quality Logo" class="logo">
  <h1>Belgium Campus Quality Repository V1.0</h1>

  <div style="text-align:center; clear:both;">
    <button id="authButton">üîê Sign in with Google</button>
  </div>

  <div style="text-align:center; margin-top:1em;">
    <label for="filterDomain">Domain:</label>
    <select id="filterDomain"><option value="">All</option></select>

    <label for="filterTheme">Theme:</label>
    <select id="filterTheme" disabled><option value="">All</option></select>

    <label for="filterDocument">Document:</label>
    <select id="filterDocument" disabled><option value="">All</option></select>
  </div>

  <div id="tableContainer"></div>

  <!-- üÜï Evaluation Toggle Button -->
  <div style="text-align:center; margin-top: 1em;">
    <button id="toggleEvalFormBtn">üìù Evaluate Document</button>
  </div>

  <!-- üÜï Evaluation Form -->
  <div id="evaluationForm" style="display: none; margin: 2em; padding: 1em; border: 2px solid #ccc; border-radius: 8px; background: #f9f9f9; max-width: 600px;">
    <h3>Evaluation Form</h3>

    <label for="contextSelect"><strong>Context:</strong></label>
    <select id="contextSelect">
      <option value="Internal">Internal</option>
      <option value="External">External</option>
    </select>

    <br><br>

    <label for="userEmailDisplay"><strong>User:</strong></label>
    <input type="text" id="userEmailDisplay" readonly style="width: 100%;">

    <br><br>

    <button id="submitEvalBtn">‚úÖ Submit Evaluation</button>

    <!-- Hidden Inputs -->
    <input type="hidden" id="documentName">
    <input type="hidden" id="versionNumber">
    <input type="hidden" id="userEmail">
  </div>





<script>
  const clientId = '566030013012-fp4pfljo6t586lo83dq7cdf7umcs07td.apps.googleusercontent.com';
  const sheetId = '1kSctyDuy35alQsG_vN7FswSs2wKGNmk2T-N1MJWYQvI';
  const sheetName = 'documents';
  let accessToken = '';
  let userEmail = '';

  document.getElementById("authButton").addEventListener("click", () => {
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email',
      callback: async (tokenResponse) => {
        accessToken = tokenResponse.access_token;

        // Get user email
        try {
          const userRes = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          const userData = await userRes.json();
          userEmail = userData.email || '';
          document.getElementById("userEmail").value = userEmail;
          document.getElementById("userEmailDisplay").value = userEmail;
        } catch (e) {
          alert("‚ùå Failed to get user email.");
          return;
        }

        loadSheet();
      }
    });

    tokenClient.requestAccessToken();
  });

  async function loadSheet() {
    try {
      const docRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const docData = await docRes.json();
      const allData = docData.values || [];

      setupFilters(allData);
      renderTable(allData);

      const headers = allData[0];
      const firstRow = allData[1];
      const docIndex = headers.indexOf("Document");
      const verIndex = headers.indexOf("Version");

      document.getElementById("documentName").value = firstRow[docIndex] || '';
      document.getElementById("versionNumber").value = firstRow[verIndex] || '';
    } catch (err) {
      console.error("Error loading sheet:", err);
      alert("‚ö†Ô∏è Failed to load data.");
    }
  }

  // Toggle Evaluation Form visibility
  document.getElementById("toggleEvalFormBtn").addEventListener("click", () => {
    const form = document.getElementById("evaluationForm");
    form.style.display = (form.style.display === "none") ? "block" : "none";
  });

  // Submit Evaluation
  document.getElementById("submitEvalBtn").addEventListener("click", async () => {
    const documentName = document.getElementById("documentName").value;
    const versionNumber = document.getElementById("versionNumber").value;
    const context = document.getElementById("contextSelect").value;
    const user = document.getElementById("userEmail").value;

    if (!documentName || !versionNumber || !user) {
      alert("‚ö†Ô∏è Missing data. Please make sure you're signed in and a document is loaded.");
      return;
    }

    const row = [[documentName, versionNumber, context, user]];

    try {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/evaluations:append?valueInputOption=USER_ENTERED`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ values: row })
      });

      if (!res.ok) throw new Error("Failed to write");

      alert("‚úÖ Evaluation submitted!");
    } catch (err) {
      console.error(err);
      alert("‚ùå Submission error.");
    }
  });
</script>
</body>
</html>
