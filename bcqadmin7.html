
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BCQAdmin</title>
  <meta name="color-scheme" content="light dark" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{--bg:#ffffff;--surface:#ffffff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--primary:#3b82f6;--primary-ink:#ffffff;--primary-600:#2563eb;--ring:rgba(59,130,246,.35);--warn:#f59e0b;--success:#10b981;--danger:#ef4444;--radius-sm:8px;--radius:12px;--radius-lg:16px;--shadow:0 1px 2px rgba(0,0,0,.06),0 6px 16px rgba(0,0,0,.06);--sans:Calibri, Arial, system-ui,-apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;--title-bg:#e3e3e3;--space-1:.5rem;--space-2:1rem;--space-3:1.5rem;--space-4:2rem}
    @media (prefers-color-scheme: dark){:root{--bg:#0b1020;--surface:#121a2e;--text:#e5e7eb;--muted:#9aa3b2;--border:#1f2a44;--primary:#60a5fa;--primary-ink:#0b1020;--primary-600:#3b82f6;--ring:rgba(96,165,250,.45);--shadow:0 1px 2px rgba(0,0,0,.45),0 6px 16px rgba(0,0,0,.35);--title-bg:#19233d}img.logo{filter:brightness(.95) contrast(1.05)}}
    *{box-sizing:border-box}html,body{height:100%}
    body{font-family:var(--sans);color:var(--text);background:var(--bg);font-size:16px;line-height:1.55;margin:0}
    .app-header{display:block;padding:0;border-bottom:1px solid var(--border);background:var(--surface)}
    .logo{float:left;height:auto;max-height:100px;width:auto;margin:1em;background:#fff}
    .bcq-page-title{text-align:center;background:var(--title-bg);margin:0;padding:.75em 0;font-size:28px;font-weight:bold;clear:both}
    .container{max-width:none;width:100vw;margin:var(--space-2) 0 var(--space-3) 0;padding:0}
    .controls{display:flex;gap:.75rem;justify-content:center;align-items:center;margin:12px 0}
    button,select{font:inherit;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text);padding:.6rem .9rem;line-height:1;transition:box-shadow .15s ease,border-color .15s ease,background .15s ease,transform .06s ease}
    button{background:linear-gradient(180deg,var(--primary),var(--primary-600));color:var(--primary-ink);border:0;box-shadow:0 1px 0 rgba(255,255,255,.15) inset, 0 4px 10px rgba(59,130,246,.25)}
    button:hover{transform:translateY(-1px)}button:active{transform:translateY(0)}button:disabled{opacity:.6;cursor:not-allowed}
    #tableContainer{overflow-x:auto;margin:1rem 0 0}
    table{border-collapse:separate;border-spacing:0;width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    thead th{position:sticky;top:0;z-index:1;background:linear-gradient(180deg,rgba(0,0,0,.02),transparent),var(--surface);text-align:left;font-weight:700;font-size:.92rem}
    th,td{padding:.75rem .9rem;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:nth-child(even){background:rgba(0,0,0,.02)}tbody tr:hover{background:rgba(59,130,246,.06)}
    td button{padding:.45rem .7rem;min-width:unset;box-shadow:none;border-radius:8px}
    td.intent div, td.assertions div, td.impact div, td.evidence div{background:transparent;border:1px dashed var(--border);border-radius:8px;padding:.55rem .65rem;min-height:44px;line-height:1.45;overflow-y:auto;max-height:160px}
    td.intent div:hover, td.assertions div:hover, td.impact div:hover, td.evidence div:hover{border-color:rgba(59,130,246,.45)}
    #error{display:none;margin:1rem auto 0;max-width:1200px;padding:.75rem 1rem;border:1px solid #fca5a5;background:#fef2f2;color:#991b1b;border-radius:12px}
  </style>
</head>
<body class="bcq-plain-bg">
  <header class="app-header">
    <img class="logo" src="bcquality.jpeg" alt="BC Quality Logo (place this next to the HTML file)" />
    <h1 class="bcq-page-title">Belgium Campus Quality Repository - ADMIN VIEW v1.0</h1>
  </header>

  <main class="container">
    <div class="controls">
      <button id="authButton">üîê Sign in with Google</button>
      <button id="addRow" style="display:none;">‚ûï Add Row</button>
      <button id="saveChanges" style="display:none;">üíæ Save</button>
    </div>

    <div id="error"></div>
    <div id="tableContainer"></div>
  </main>

  <script>
    // ===== CONFIG =====
    const clientId = '566030013012-fp4pfljo6t586lo83dq7cdf7umcs07td.apps.googleusercontent.com';
    const sheetId = '1kSctyDuy35alQsG_vN7FswSs2wKGNmk2T-N1MJWYQvI';
    const sheetName = 'documents';

    // If Google API fails (local file, blocked popup, wrong origin), we show mock data so styling is visible
    const MOCK = [
      ['Domain','Theme','Document','Intent','Assertions','Impact','Evidence','Link'],
      ['Governance','Risk','Policy A','High-level intent here','Key claims','Expected outcomes','Citations','https://example.com'],
      ['Quality','Teaching','Template B','Intent text','Assertions text','Impact text','Evidence text','']
    ];

    let accessToken = '';
    let categoryHeaders = [];
    let categoryDataByHeader = {};

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const errorBox = $('#error');
    function showError(msg){ errorBox.textContent = msg; errorBox.style.display = 'block'; }

    // ===== AUTH =====
    $('#authButton').addEventListener('click', () => {
      try{
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: 'https://www.googleapis.com/auth/spreadsheets',
          callback: tokenResponse => { accessToken = tokenResponse.access_token; loadSheet(); }
        });
        tokenClient.requestAccessToken();
      }catch(err){
        showError('Sign-in failed to initialize. Are you opening the file via HTTPS and from an allowed origin in your Google Cloud credentials?');
        // Still render mock so user sees the UI
        renderTable(MOCK);
      }
    });

    // ===== LOAD SHEET =====
    async function loadSheet(){
      try{
        // 1) documents
        const docRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (!docRes.ok) throw new Error('Sheets API error (documents): ' + docRes.status);
        const docData = await docRes.json();
        const values = docData.values || [];
        if (!values.length) throw new Error('Sheet returned no rows.');
        renderTable(values);
        $('#addRow').style.display = 'inline-block';
        $('#saveChanges').style.display = 'inline-block';

        // 2) categories (optional)
        const catRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/categories`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (catRes.ok){
          const catData = await catRes.json();
          const rows = catData.values || [];
          categoryHeaders = rows[0] || [];
          categoryDataByHeader = {};
          for (let i=0;i<categoryHeaders.length;i++){
            const colData = [];
            for (let j=1;j<rows.length;j++) if (rows[j] && rows[j][i]) colData.push(rows[j][i].trim());
            categoryDataByHeader[categoryHeaders[i]] = colData;
          }
        }
      }catch(err){
        console.error(err);
        showError('‚ö†Ô∏è Could not load from Google Sheets. Showing a styled preview with mock data instead.\nDetails: ' + err.message);
        renderTable(MOCK);
      }
    }

    // ===== RENDER TABLE =====
    function renderTable(data){
      const container = $('#tableContainer');
      container.innerHTML = '';
      if (!data || !data.length){ container.textContent = 'No data.'; return; }

      const table = document.createElement('table');

      // Head
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      data[0].forEach(h => {
        const th = document.createElement('th');
        th.textContent = (h||'').trim();
        headerRow.appendChild(th);
      });
      const delTh = document.createElement('th'); delTh.textContent = 'Delete'; headerRow.appendChild(delTh);
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const idx = name => data[0].findIndex(h => (h||'').trim().toLowerCase() === name.toLowerCase());
      const idxIntent = idx('Intent');
      const idxAssertions = idx('Assertions');
      const idxImpact = idx('Impact');
      const idxEvidence = idx('Evidence');

      // Body
      const tbody = document.createElement('tbody');
      data.slice(1).forEach(rowData => {
        const tr = document.createElement('tr');
        (rowData || []).forEach((cell, colIndex) => {
          const td = document.createElement('td');
          const headerText = (data[0][colIndex] || '').trim();
          const cleanCell = (cell || '').trim();

          // Styled long-text blocks
          if (colIndex === idxIntent) td.classList.add('intent');
          if (colIndex === idxAssertions) td.classList.add('assertions');
          if (colIndex === idxImpact) td.classList.add('impact');
          if (colIndex === idxEvidence) td.classList.add('evidence');

          // Link button
          if (headerText === 'Link' && cleanCell.startsWith('http')){
            const btn = document.createElement('button');
            btn.textContent = 'üîó Open Link';
            btn.dataset.link = cleanCell;
            btn.onclick = () => window.open(cleanCell, '_blank');
            td.appendChild(btn);
          } else {
            if (td.classList.contains('intent') || td.classList.contains('assertions') || td.classList.contains('impact') || td.classList.contains('evidence')){
              const div = document.createElement('div');
              div.contentEditable = 'true';
              div.textContent = cleanCell;
              td.appendChild(div);
            } else {
              td.contentEditable = 'true';
              td.textContent = cleanCell;
            }
          }
          tr.appendChild(td);
        });

        // Delete row button (client-side)
        const tdDel = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.title = 'Remove row (not saved until you click Save)';
        delBtn.onclick = () => tr.remove();
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      container.appendChild(table);
    }

    // ===== ADD ROW =====
    $('#addRow').addEventListener('click', () => {
      const table = document.querySelector('#tableContainer table');
      if (!table) return;
      const headerCells = table.tHead.rows[0].cells;
      const cols = headerCells.length - 1; // omit Delete column
      const tr = document.createElement('tr');

      for (let i=0;i<cols;i++){
        const headerText = headerCells[i].textContent.trim();
        const td = document.createElement('td');

        if (["Intent","Assertions","Impact","Evidence"].includes(headerText)){
          if (headerText === 'Intent') td.classList.add('intent');
          if (headerText === 'Assertions') td.classList.add('assertions');
          if (headerText === 'Impact') td.classList.add('impact');
          if (headerText === 'Evidence') td.classList.add('evidence');
          const div = document.createElement('div');
          div.contentEditable = 'true';
          td.appendChild(div);
        } else if (headerText === 'Domain'){
          const select = document.createElement('select');
          const defaultOption = document.createElement('option');
          defaultOption.textContent = 'Select';
          defaultOption.value = '';
          select.appendChild(defaultOption);
          (categoryHeaders||[]).forEach(opt => {
            const option = document.createElement('option');
            option.value = option.textContent = opt;
            select.appendChild(option);
          });
          td.appendChild(select);
        } else if (headerText === 'Theme'){
          const select = document.createElement('select');
          select.disabled = true;
          td.appendChild(select);
        } else if (headerText === 'Type'){
          const select = document.createElement('select');
          ['', 'Policy','Framework','Report','Template','Protocol','Guideline','Unspecified'].forEach(opt => {
            const option = document.createElement('option');
            option.value = option.textContent = opt;
            select.appendChild(option);
          });
          td.appendChild(select);
        } else if (headerText === 'Status'){
          const select = document.createElement('select');
          ['', 'Draft','Active','Inactive'].forEach(opt => {
            const option = document.createElement('option');
            option.value = option.textContent = opt;
            select.appendChild(option);
          });
          td.appendChild(select);
        } else {
          td.contentEditable = 'true';
        }
        tr.appendChild(td);
      }

      // Domain‚ÜíTheme wiring
      const domainIndex = Array.from(headerCells).findIndex(h => h.textContent.trim() === 'Domain');
      const themeIndex = Array.from(headerCells).findIndex(h => h.textContent.trim() === 'Theme');
      const domainCell = tr.cells[domainIndex];
      const themeCell = tr.cells[themeIndex];
      if (domainCell && themeCell){
        const domainSelect = domainCell.querySelector('select');
        const themeSelect = themeCell.querySelector('select');
        domainSelect.addEventListener('change', () => {
          const domain = domainSelect.value;
          themeSelect.innerHTML = '';
          if (domain && categoryDataByHeader[domain]){
            themeSelect.disabled = false;
            categoryDataByHeader[domain].forEach(item => {
              const option = document.createElement('option');
              option.value = option.textContent = item;
              themeSelect.appendChild(option);
            });
          } else {
            themeSelect.disabled = true;
          }
        });
      }

      const tdDel = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.onclick = () => tr.remove();
      tdDel.appendChild(delBtn);
      tr.appendChild(tdDel);

      // Single change: insert new row at the TOP instead of bottom
      table.tBodies[0].insertBefore(tr, table.tBodies[0].firstChild);
    });

    // ===== SAVE =====
    $('#saveChanges').addEventListener('click', async () => {
      const table = document.querySelector('#tableContainer table');
      if (!table) return;
      const values = [];
      const headerRow = Array.from(table.tHead.rows[0].cells).slice(0, -1).map(th => th.textContent.trim());
      values.push(headerRow);

      for (let tr of table.tBodies[0].rows){
        const cells = Array.from(tr.cells).slice(0, -1);
        const rowData = cells.map(cell => {
          const select = cell.querySelector('select');
          if (select) return (select.value||'').trim();
          const btn = cell.querySelector('button');
          if (btn && btn.dataset.link) return btn.dataset.link;
          const div = cell.querySelector('div[contenteditable]');
          if (div) return (div.textContent||'').trim();
          return (cell.textContent||'').trim();
        });
        if (rowData.some(cell => cell !== '')) values.push(rowData);
      }

      try{
        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}:clear`, {
          method:'POST',
          headers:{ Authorization:`Bearer ${accessToken}`, 'Content-Type':'application/json' }
        });
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?valueInputOption=RAW`, {
          method:'PUT',
          headers:{ Authorization:`Bearer ${accessToken}`, 'Content-Type':'application/json' },
          body: JSON.stringify({ values })
        });
        if (!res.ok) throw new Error('Sheets API error (save): ' + res.status);
        const result = await res.json();
        console.log('‚úÖ Sheet updated:', result);
        alert('‚úÖ Sheet successfully cleared and updated!');
      } catch(err){
        console.error('‚ùå Save failed:', err);
        showError('‚ùå Save failed: ' + err.message);
      }
    });
  </script>
</body>
</html>
