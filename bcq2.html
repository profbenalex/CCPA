<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Google Sheet Editor ‚Äì Final Fix</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #999; padding: 0.5em; text-align: left; }
    th { background-color: #eee; }
    td[contenteditable="true"] { background-color: #ffffcc; }
    button { margin: 0.5em 0.5em 0.5em 0; }
    select { background-color: #ffffcc; }
  </style>
</head>
<body>
  <h2>üìÑ Google Sheet Editor (Final)</h2>
  <button id="authButton">üîê Sign in with Google</button>
  <button id="addRow" style="display:none;">‚ûï Add Row</button>
  <button id="saveChanges" style="display:none;">üíæ Save</button>
  <div id="tableContainer"></div>

  <script>
    const clientId = '566030013012-fp4pfljo6t586lo83dq7cdf7umcs07td.apps.googleusercontent.com';
    const sheetId = '1kSctyDuy35alQsG_vN7FswSs2wKGNmk2T-N1MJWYQvI';
    const sheetName = 'documents';
    let accessToken = '';
    let themeOptions = [];

    document.getElementById("authButton").addEventListener("click", () => {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: tokenResponse => {
          accessToken = tokenResponse.access_token;
          loadSheet();
        }
      });
      tokenClient.requestAccessToken();
    });

    function loadSheet() {
      // Load main sheet
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      })
      .then(res => res.json())
      .then(data => {
        renderTable(data.values || []);
        document.getElementById("addRow").style.display = "inline";
        document.getElementById("saveChanges").style.display = "inline";
      });

      // Load theme dropdown options from categories!1:1
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/categories!1:1`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      })
      .then(res => res.json())
      .then(data => {
        themeOptions = data.values[0] || [];
        console.log("üé® Theme dropdown options:", themeOptions);
      });
    }

    function renderTable(data) {
      const container = document.getElementById("tableContainer");
      container.innerHTML = "";
      const table = document.createElement("table");

      // Header row
      const headerRow = document.createElement("tr");
      data[0].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      const delTh = document.createElement("th");
      delTh.textContent = "Delete";
      headerRow.appendChild(delTh);
      table.appendChild(headerRow);

      // Data rows
      data.slice(1).forEach(rowData => {
        const tr = document.createElement("tr");
        rowData.forEach((cell, colIndex) => {
          const td = document.createElement("td");
          td.contentEditable = "true";
          td.textContent = cell;
          tr.appendChild(td);
        });
        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è";
        delBtn.onclick = () => tr.remove();
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);
        table.appendChild(tr);
      });

      container.appendChild(table);
    }

    document.getElementById("addRow").addEventListener("click", () => {
      const table = document.querySelector("table");
      const headerCells = table.rows[0].cells;
      const cols = headerCells.length - 1;
      const tr = document.createElement("tr");

      for (let i = 0; i < cols; i++) {
        const headerText = headerCells[i].textContent.trim();
        const td = document.createElement("td");

        if (headerText === "Theme" && themeOptions.length > 0) {
          const select = document.createElement("select");
          themeOptions.forEach(opt => {
            const option = document.createElement("option");
            option.value = option.textContent = opt;
            select.appendChild(option);
          });
          td.appendChild(select);
        } else {
          td.contentEditable = "true";
          td.textContent = "";
        }

        tr.appendChild(td);
      }

      const tdDel = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "üóëÔ∏è";
      delBtn.onclick = () => tr.remove();
      tdDel.appendChild(delBtn);
      tr.appendChild(tdDel);
      table.appendChild(tr);
    });

    document.getElementById("saveChanges").addEventListener("click", async () => {
      const table = document.querySelector("table");
      const values = [];
      for (let row of table.rows) {
        const cells = Array.from(row.cells).slice(0, -1); // skip delete button
        const rowData = cells.map(cell => {
          const select = cell.querySelector("select");
          return select ? select.value.trim() : cell.textContent.trim();
        });
        if (values.length === 0 || rowData.some(cell => cell !== '')) {
          values.push(rowData);
        }
      }

      console.log("üì§ Final Save values:", values);

      try {
        // Step 1: Clear the sheet
        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}:clear`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          }
        });

        // Step 2: Write updated values
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?valueInputOption=RAW`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ values })
        });

        const result = await res.json();
        console.log("‚úÖ Sheet updated:", result);
        alert("‚úÖ Sheet successfully cleared and updated!");
      } catch (err) {
        console.error("‚ùå Save failed:", err);
        alert("‚ùå Save failed: " + err.message);
      }
    });
  </script>
</body>
</html>
