<!DOCTYPE html>
<html>
<head>
  <title>CCPA Members Register</title>
  <meta name="google-signin-client_id" content="290713393187-sfvukqfmffktomufhtuknnvcjk55e3a8.apps.googleusercontent.com">
</head>
<body>
  <h2>CCPA Members Register</h2>

  <button onclick="handleAuthClick()">🔐 Authorize</button>
  <button onclick="listData()">📖 Read Sheet</button>
  <button onclick="appendRow()">📝 Add Row</button>

  <pre id="output">Waiting for user action...</pre>

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = '290713393187-sfvukqfmffktomufhtuknnvcjk55e3a8.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1FUzgEatxn_pr2LkqDdRq0m0kPC6zsX0T0J3-MBifqD4';
    const SHEET_NAME = 'register';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    function log(message) {
      document.getElementById('output').textContent += `\n${message}`;
      console.log(message);
    }

    function gapiLoaded() {
      gapi.load('client:auth2', initializeGapiClient);
    }

    async function initializeGapiClient() {
      try {
        await gapi.client.init({
          clientId: CLIENT_ID,
          scope: SCOPES,
        });
        log('✅ GAPI initialized');
      } catch (err) {
        log('❌ GAPI init failed: ' + err.message);
      }
    }

    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then(() => {
        log('✅ Signed in as: ' + gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getEmail());
      }).catch((err) => {
        log('❌ Sign-in failed: ' + err.error);
      });
    }

    async function listData() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SHEET_NAME}!A1:N`,
        });
        const rows = response.result.values;
        if (!rows || rows.length === 0) {
          log('⚠️ No data found.');
        } else {
          log(`📋 Rows found: ${rows.length}`);
          log(rows.map(row => row.join(' | ')).join('\n'));
        }
      } catch (err) {
        log('❌ Read error: ' + err.message);
      }
    }

    async function appendRow() {
      const values = [[
        "A999 Example", "Example Claim", "Doe", "Jane", "Ordinary Member",
        "1/20", "Restitution", "Pending", "http://doclink",
        "1234567890123", "0712345678", "jane@example.com",
        "123 Main St", "Test entry"
      ]];
      try {
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SHEET_NAME}!A1:N1`,
          valueInputOption: 'RAW',
          insertDataOption: 'INSERT_ROWS',
          resource: { values },
        });
        log('✅ Row added successfully.');
      } catch (err) {
        log('❌ Write error: ' + err.message);
      }
    }

    gapiLoaded(); // Start the API load immediately
  </script>
</body>
</html>
