<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belgium Campus Quality Repository ‚Äî ADMIN VIEW v1.0</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Apply your consolidated theme -->
  <link rel="stylesheet" href="bcq-theme.css" />
  <meta name="color-scheme" content="light dark" />
  <style>
    /* Page‚Äëspecific tweaks (optional). Keep theme untouched. */
    .controls.actions { gap: .75rem; }
  </style>
</head>
<body class="bcq-plain-bg">
  <!-- Header with logo + banner title (mirrors your reference) -->
  <header class="app-header">
    <img class="logo" src="bcquality.jpeg" alt="BC Quality Logo" />
    <h1 class="bcq-page-title">Belgium Campus Quality Repository - ADMIN VIEW v1.0</h1>
  </header>

  <main class="container">
    <!-- Auth / CRUD controls -->
    <div class="controls actions center">
      <button id="authButton">üîê Sign in with Google</button>
      <button id="addRow" style="display:none;">‚ûï Add Row</button>
      <button id="saveChanges" style="display:none;">üíæ Save</button>
    </div>

    <!-- Data table -->
    <div id="tableContainer"></div>
  </main>

  <script>
    // === Google Sheets + Admin logic (unchanged, just re-attached) ===
    const clientId = '566030013012-fp4pfljo6t586lo83dq7cdf7umcs07td.apps.googleusercontent.com';
    const sheetId = '1kSctyDuy35alQsG_vN7FswSs2wKGNmk2T-N1MJWYQvI';
    const sheetName = 'documents';
    let accessToken = '';

    // Domain‚ÜíTheme cascading lists
    let categoryHeaders = [];
    let categoryDataByHeader = {};

    document.getElementById('authButton').addEventListener('click', () => {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: tokenResponse => { accessToken = tokenResponse.access_token; loadSheet(); }
      });
      tokenClient.requestAccessToken();
    });

    async function loadSheet(){
      try{
        // Documents sheet
        const docRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        const docData = await docRes.json();
        renderTable(docData.values || []);
        document.getElementById('addRow').style.display = 'inline-block';
        document.getElementById('saveChanges').style.display = 'inline-block';

        // Categories sheet (for Domain‚ÜíTheme)
        const catRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/categories`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        const catData = await catRes.json();
        const rows = catData.values || [];
        categoryHeaders = rows[0] || [];
        categoryDataByHeader = {};
        for (let i=0;i<categoryHeaders.length;i++){
          const colData = [];
          for (let j=1;j<rows.length;j++) if (rows[j] && rows[j][i]) colData.push(rows[j][i].trim());
          categoryDataByHeader[categoryHeaders[i]] = colData;
        }
      }catch(err){
        console.error('Error loading data', err);
        alert('‚ö†Ô∏è Failed to load data.');
      }
    }

    function renderTable(data){
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';
      if (!data || !data.length){ container.textContent = 'No data.'; return; }

      const table = document.createElement('table');

      // Head
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      data[0].forEach(h => {
        const th = document.createElement('th');
        th.textContent = (h||'').trim();
        headerRow.appendChild(th);
      });
      const delTh = document.createElement('th'); delTh.textContent = 'Delete'; headerRow.appendChild(delTh);
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement('tbody');
      data.slice(1).forEach(rowData => {
        const tr = document.createElement('tr');
        (rowData || []).forEach((cell, colIndex) => {
          const td = document.createElement('td');
          const headerText = (data[0][colIndex] || '').trim();
          const cleanCell = (cell || '').trim();

          if (["Intent","Assertions","Impact","Evidence"].includes(headerText)){
            if (headerText === 'Intent') td.classList.add('intent');
            if (headerText === 'Assertions' || headerText === 'Evidence') td.classList.add('content');
            if (headerText === 'Impact') td.classList.add('impact');
            const div = document.createElement('div');
            div.contentEditable = 'true';
            div.textContent = cleanCell;
            td.appendChild(div);
          } else if (headerText === 'Link' && cleanCell.startsWith('https://')){
            const btn = document.createElement('button');
            btn.textContent = 'üîó Open Link';
            btn.onclick = () => window.open(cleanCell, '_blank');
            btn.dataset.link = cleanCell;
            td.appendChild(btn);
          } else {
            td.contentEditable = 'true';
            td.textContent = cleanCell;
          }
          tr.appendChild(td);
        });

        // Delete row button (client-side until Save)
        const tdDel = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.title = 'Remove row (not saved until you click Save)';
        delBtn.onclick = () => tr.remove();
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      container.appendChild(table);
    }

    // Add row with Domain‚ÜíTheme dependent selects
    document.getElementById('addRow').addEventListener('click', () => {
      const table = document.querySelector('#tableContainer table');
      if (!table) return;
      const headerCells = table.tHead.rows[0].cells;
      const cols = headerCells.length - 1; // omit Delete column
      const tr = document.createElement('tr');

      for (let i=0;i<cols;i++){
        const headerText = headerCells[i].textContent.trim();
        const td = document.createElement('td');

        if (["Intent","Assertions","Impact","Evidence"].includes(headerText)){
          if (headerText === 'Intent') td.classList.add('intent');
          if (headerText === 'Assertions' || headerText === 'Evidence') td.classList.add('content');
          if (headerText === 'Impact') td.classList.add('impact');
          const div = document.createElement('div');
          div.contentEditable = 'true';
          td.appendChild(div);
        } else if (headerText === 'Domain'){
          const select = document.createElement('select');
          const defaultOption = document.createElement('option');
          defaultOption.textContent = 'Select';
          defaultOption.value = '';
          select.appendChild(defaultOption);
          categoryHeaders.forEach(opt => {
            const option = document.createElement('option');
            option.value = option.textContent = opt;
            select.appendChild(option);
          });
          td.appendChild(select);
        } else if (headerText === 'Theme'){
          const select = document.createElement('select');
          select.disabled = true;
          td.appendChild(select);
        } else if (headerText === 'Type'){
          const select = document.createElement('select');
          ['', 'Policy','Framework','Report','Template','Protocol','Guideline','Unspecified'].forEach(opt => {
            const option = document.createElement('option');
            option.value = option.textContent = opt;
            select.appendChild(option);
          });
          td.appendChild(select);
        } else if (headerText === 'Status'){
          const select = document.createElement('select');
          ['', 'Draft','Active','Inactive'].forEach(opt => {
            const option = document.createElement('option');
            option.value = option.textContent = opt;
            select.appendChild(option);
          });
          td.appendChild(select);
        } else {
          td.contentEditable = 'true';
        }
        tr.appendChild(td);
      }

      // Wire Domain‚ÜíTheme
      const domainIndex = Array.from(headerCells).findIndex(h => h.textContent.trim() === 'Domain');
      const themeIndex = Array.from(headerCells).findIndex(h => h.textContent.trim() === 'Theme');
      const domainCell = tr.cells[domainIndex];
      const themeCell = tr.cells[themeIndex];
      if (domainCell && themeCell){
        const domainSelect = domainCell.querySelector('select');
        const themeSelect = themeCell.querySelector('select');
        domainSelect.addEventListener('change', () => {
          const domain = domainSelect.value;
          themeSelect.innerHTML = '';
          if (domain && categoryDataByHeader[domain]){
            themeSelect.disabled = false;
            categoryDataByHeader[domain].forEach(item => {
              const option = document.createElement('option');
              option.value = option.textContent = item;
              themeSelect.appendChild(option);
            });
          } else {
            themeSelect.disabled = true;
          }
        });
      }

      // Delete button
      const tdDel = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.onclick = () => tr.remove();
      tdDel.appendChild(delBtn);
      tr.appendChild(tdDel);

      table.tBodies[0].appendChild(tr);
    });

    // Save back to Google Sheets (clear+replace)
    document.getElementById('saveChanges').addEventListener('click', async () => {
      const table = document.querySelector('#tableContainer table');
      if (!table) return;
      const values = [];

      // Header row (skip Delete col)
      const headerRow = Array.from(table.tHead.rows[0].cells)
        .slice(0, -1)
        .map(th => th.textContent.trim());
      values.push(headerRow);

      // Body rows
      for (let tr of table.tBodies[0].rows){
        const cells = Array.from(tr.cells).slice(0, -1);
        const rowData = cells.map(cell => {
          const select = cell.querySelector('select');
          if (select) return (select.value||'').trim();
          const btn = cell.querySelector('button');
          if (btn && btn.dataset.link) return btn.dataset.link;
          const div = cell.querySelector('div[contenteditable]');
          if (div) return (div.textContent||'').trim();
          return (cell.textContent||'').trim();
        });
        if (rowData.some(cell => cell !== '')) values.push(rowData);
      }

      try{
        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}:clear`, {
          method:'POST',
          headers:{ Authorization:`Bearer ${accessToken}`, 'Content-Type':'application/json' }
        });
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?valueInputOption=RAW`, {
          method:'PUT',
          headers:{ Authorization:`Bearer ${accessToken}`, 'Content-Type':'application/json' },
          body: JSON.stringify({ values })
        });
        const result = await res.json();
        console.log('‚úÖ Sheet updated:', result);
        alert('‚úÖ Sheet successfully cleared and updated!');
      } catch(err){
        console.error('‚ùå Save failed:', err);
        alert('‚ùå Save failed: ' + err.message);
      }
    });
  </script>
</body>
</html>
