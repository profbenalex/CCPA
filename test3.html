<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>bcquality Sheet Editor</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #999;
      padding: 0.5em;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    td[contenteditable="true"] {
      background-color: #ffffdd;
    }
    button {
      margin-top: 1em;
      margin-right: 0.5em;
    }
  </style>
</head>
<body>
  <h2>üìÑ bcquality Sheet Editor 3.4</h2>
  <button id="authButton">üîê Sign in with Google</button>
  <div id="outputContainer"></div>
  <button id="saveButton" style="display:none;">üíæ Save Changes</button>
  <button id="addRowButton" style="display:none;">‚ûï Add Row</button>

  <script>
    const clientId = '566030013012-fp4pfljo6t586lo83dq7cdf7umcs07td.apps.googleusercontent.com';
    const sheetId = '1kSctyDuy35alQsG_vN7FswSs2wKGNmk2T-N1MJWYQvI';
    let tokenClient;
    let accessToken = '';
    let originalHeader = [];

    document.getElementById("authButton").addEventListener("click", () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          fetchSheetData();
        },
      });
      tokenClient.requestAccessToken();
    });

    function fetchSheetData() {
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/documents`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      })
      .then(res => res.json())
      .then(data => {
        const sheetData = data.values || [];
        originalHeader = sheetData[0];
        renderTable(sheetData);
        document.getElementById("saveButton").style.display = "inline";
        document.getElementById("addRowButton").style.display = "inline";
      })
      .catch(err => {
        document.getElementById("outputContainer").textContent = '‚ùå Error: ' + err;
      });
    }

    function renderTable(data) {
      const outputContainer = document.getElementById("outputContainer");
      outputContainer.innerHTML = "";
      const table = document.createElement("table");

      // Header row
      const headerRow = document.createElement("tr");
      data[0].forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        headerRow.appendChild(th);
      });
      const thDelete = document.createElement("th");
      thDelete.textContent = "Delete";
      headerRow.appendChild(thDelete);
      table.appendChild(headerRow);

      // Data rows
      for (let i = 1; i < data.length; i++) {
        const tr = document.createElement("tr");

        data[i].forEach(cell => {
          const td = document.createElement("td");
          td.contentEditable = "true";
          td.textContent = cell;
          tr.appendChild(td);
        });

        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è";
        delBtn.onclick = () => tr.remove();  // only remove from DOM
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);
        table.appendChild(tr);
      }

      outputContainer.appendChild(table);
    }

    document.getElementById("addRowButton").addEventListener("click", () => {
      const table = document.querySelector("table");
      const newRow = document.createElement("tr");

      originalHeader.forEach(() => {
        const td = document.createElement("td");
        td.contentEditable = "true";
        td.textContent = "";
        newRow.appendChild(td);
      });

      const tdDel = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "üóëÔ∏è";
      delBtn.onclick = () => newRow.remove();
      tdDel.appendChild(delBtn);
      newRow.appendChild(tdDel);
      table.appendChild(newRow);
    });

    document.getElementById("saveButton").addEventListener("click", () => {
      const table = document.querySelector("table");
      const rows = table.querySelectorAll("tr");
      const newData = [];

      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].querySelectorAll("td, th");
        const row = [];

        for (let j = 0; j < cells.length - 1; j++) { // ignore last column (Delete)
          row.push(cells[j].textContent.trim());
        }

        // Push row if not completely empty
        if (row.length && (i === 0 || row.some(cell => cell !== ""))) {
          newData.push(row);
        }
      }

      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/documents?valueInputOption=RAW`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ values: newData })
      })
      .then(res => res.json())
      .then(() => {
        alert("‚úÖ Sheet updated successfully!");
        fetchSheetData(); // Refresh after save
      })
      .catch(err => {
        alert("‚ùå Failed to update sheet: " + err);
      });
    });
  </script>
</body>
</html>
