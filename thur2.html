<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CCPA Members Register</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #f4f4f4;
    }
    .button-row {
      margin-top: 24px;
    }
    button {
      margin-right: 10px;
      padding: 8px 14px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h1>CCPA Members Register</h1>

  <div class="button-row">
    <button id="signinBtn">Sign In</button>
    <button id="writeBtn" disabled>Write Dummy Row</button>
  </div>

  <h2>ðŸ“– Live Register</h2>
  <table id="liveTable">
    <thead id="liveHeaders"></thead>
    <tbody id="liveBody"></tbody>
  </table>

  <script>
    const CLIENT_ID = "290713393187-sfvukqfmffktomufhtuknnvcjk55e3a8.apps.googleusercontent.com";
    const SHEET_ID = "1FUzgEatxn_pr2LkqDdRq0m0kPC6zsX0T0J3-MBifqD4";
    const RANGE = "register";
    let accessToken = "";

    const dummyRow = [
      "X123", "RamaphosaC", "Roberts", "Mary Bether", "Claim Representative",
      "1/3", "Power of Attorney", "Complete", "document123", "1234567890",
      "1234567890", "name@gmail.com", "13 Dark, Side, 1234", "Dummy data"
    ];

    // Auth flow
    document.getElementById("signinBtn").addEventListener("click", () => {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/spreadsheets",
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById("writeBtn").disabled = false;
          alert("Signed in. You can now write to the register.");
        }
      });
      tokenClient.requestAccessToken();
    });

    // Write to Sheet
    document.getElementById("writeBtn").addEventListener("click", () => {
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}:append?valueInputOption=RAW`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ values: [dummyRow] })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Row written:", data);
        alert("Dummy row successfully added to register.");
      })
      .catch(err => {
        console.error("Write error:", err);
        alert("Error writing to register. See console.");
      });
    });

    // Read from Apps Script register endpoint (GET)
    const readURL = "https://script.google.com/macros/s/AKfycbwyCKv12a0cEC9Hty0zqCXPff0Ubrv-oXOQVkTD1p_ZhC8X30sx7VEJQFpPZ5LtUA90FQ/exec";
    fetch(readURL)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) return;

        const headers = Object.keys(data[0]);
        const headerRow = document.createElement("tr");
        headers.forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          headerRow.appendChild(th);
        });
        document.getElementById("liveHeaders").appendChild(headerRow);

        data.forEach(entry => {
          const tr = document.createElement("tr");
          headers.forEach(h => {
            const td = document.createElement("td");
            td.textContent = entry[h] || "";
            tr.appendChild(td);
          });
          document.getElementById("liveBody").appendChild(tr);
        });
      })
      .catch(err => {
        console.error("Read error:", err);
        document.body.insertAdjacentHTML("beforeend", "<p>Unable to load register.</p>");
      });
  </script>

</body>
</html>